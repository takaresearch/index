# 統計解析計画書

**研究課題名**: 姿勢推定アルゴリズムによる骨密度予測の精度検証

**作成日**: 2026年2月3日

**バージョン**: 1.0

---

## 1. 解析の目的

本統計解析計画書は、研究プロトコルに基づいて収集されるデータの解析手順を詳細に定義するものである。データ収集前に解析計画を確定することで、解析の透明性を確保し、多重検定によるバイアスを最小化する。

---

## 2. 解析対象集団

### 2.1 Full Analysis Set (FAS)
- 定義: 適格基準を満たし、少なくとも1回の測定(写真撮影またはDXA測定)を受けたすべての被験者
- 主要解析に使用

### 2.2 Per Protocol Set (PPS)
- 定義: プロトコルに重大な逸脱がなく、すべての測定を完了した被験者
- 感度分析に使用

### 2.3 除外基準
以下の場合、解析から除外:
- 写真撮影の品質が著しく低く、姿勢推定アルゴリズムがキーポイントを検出できない
- DXA測定データが欠損している
- 重大なプロトコル違反がある

---

## 3. 記述統計

### 3.1 被験者背景

すべての解析にFASを使用する。

#### 3.1.1 人口統計学的特性
- 年齢: 平均値±標準偏差、中央値(四分位範囲)、最小値-最大値
- 性別: n (%)
- 身長: 平均値±標準偏差
- 体重: 平均値±標準偏差
- BMI: 平均値±標準偏差

#### 3.1.2 骨密度測定値
以下の各測定部位について:
- 腰椎(L1-L4)
- 大腿骨頸部
- 大腿骨全体

各部位で:
- BMD (g/cm²): 平均値±標準偏差、中央値(IQR)
- T-score: 平均値±標準偏差、中央値(IQR)
- Z-score: 平均値±標準偏差、中央値(IQR)

骨密度分類(WHOの基準):
- 正常 (T-score ≥ -1.0): n (%)
- 骨減少症 (-2.5 < T-score < -1.0): n (%)
- 骨粗鬆症 (T-score ≤ -2.5): n (%)

#### 3.1.3 姿勢パラメータ
各パラメータについて:
- 平均値±標準偏差
- 中央値(四分位範囲)
- 最小値-最大値
- 95%信頼区間

測定する姿勢パラメータ:
1. 胸椎後弯角度(度)
2. 頭部前方位(正規化、%)
3. 腰椎前弯角度(度)
4. 矢状面垂直軸 SVA(正規化、%)
5. 体幹傾斜角度(度)
6. 頭頸部角度(度)

#### 3.1.4 2枚の写真間の測定再現性
- 級内相関係数(ICC)とその95%信頼区間
- Bland-Altman plot
- 変動係数(CV)

### 3.2 正規性の検定
- Shapiro-Wilk検定を各連続変数に実施
- p < 0.05で非正規分布と判定
- ヒストグラムとQ-Qプロットの視覚的確認

### 3.3 外れ値の検出
- 各変数について、平均値±3標準偏差を超える値を外れ値として識別
- 箱ひげ図による視覚的確認
- 外れ値の取り扱い:
  - 明らかな測定エラー: 除外
  - 生理学的に妥当な値: 保持し、感度分析で除外した場合の結果も報告

---

## 4. 主要解析

### 4.1 主要評価項目
**腰椎BMDを予測する機械学習モデルの決定係数(R²)**

### 4.2 副次評価項目
1. 大腿骨頸部BMDを予測するモデルのR²
2. 腰椎BMD予測のMAE, RMSE, MAPE
3. 大腿骨頸部BMD予測のMAE, RMSE, MAPE
4. 骨粗鬆症(T-score ≤ -2.5)の分類精度(AUC, 感度, 特異度)

### 4.3 解析手順

#### ステップ1: データ前処理

**1.1 欠損値の処理**
- 欠損値の割合を各変数について算出
- 欠損率 < 5%: 中央値(連続変数)または最頻値(カテゴリ変数)で補完
- 欠損率 ≥ 5%: 当該変数を解析から除外
- Little's MCAR検定により欠損パターンを評価

**1.2 外れ値の処理**
- 3.3節の手順に従う

**1.3 特徴量のスケーリング**
- 連続変数: 標準化(StandardScaler)
  - z = (x - μ) / σ
- カテゴリ変数: ワンホットエンコーディング

#### ステップ2: 単変量解析

**2.1 相関分析**
目的変数(腰椎BMD、大腿骨頸部BMD)と各姿勢パラメータの相関:
- 正規分布の場合: Pearsonの相関係数
- 非正規分布の場合: Spearmanの順位相関係数
- 有意水準: α = 0.05(両側検定)
- 多重比較補正: Bonferroni補正(姿勢パラメータ6個 → α = 0.05/6 = 0.0083)

**2.2 相関行列とヒートマップ**
- すべての連続変数間の相関係数を算出
- ヒートマップで可視化

**2.3 性別・年齢層別の記述統計**
- 性別(男性 vs 女性)
- 年齢層(40-54歳、55-69歳、70-80歳)
- 各群で骨密度と姿勢パラメータの平均値±標準偏差を算出

#### ステップ3: 多重共線性の確認

**3.1 分散拡大係数(VIF)**
- すべての独立変数についてVIFを算出
- VIF > 10: 多重共線性が強いと判定し、変数を除外
- VIF 5-10: 注意が必要

**3.2 相関係数**
- 独立変数間の相関係数 > 0.8: 一方を除外

#### ステップ4: モデル構築

**4.1 データ分割**
- 5分割交差検証(5-fold cross-validation)
- 各foldは層別サンプリング(骨粗鬆症の有無で層別化)
- 乱数シード固定(再現性確保)

**4.2 特徴量セット**

**ベースラインモデル(Model 0):**
- 年齢
- 性別

**拡張モデル1(Model 1):**
- 年齢
- 性別
- 胸椎後弯角度
- 頭部前方位
- 腰椎前弯角度
- 矢状面垂直軸(SVA)
- 体幹傾斜角度
- 頭頸部角度

**拡張モデル2(Model 2):**
- Model 1の全変数
- BMI

**4.3 機械学習アルゴリズム**

以下のアルゴリズムを比較:

**1. 線形回帰(Linear Regression)**
```python
from sklearn.linear_model import LinearRegression
model = LinearRegression()
```

**2. リッジ回帰(Ridge Regression)**
```python
from sklearn.linear_model import Ridge
# ハイパーパラメータ探索範囲
alphas = [0.001, 0.01, 0.1, 1, 10, 100]
```

**3. Lasso回帰**
```python
from sklearn.linear_model import Lasso
# ハイパーパラメータ探索範囲
alphas = [0.001, 0.01, 0.1, 1, 10, 100]
```

**4. ランダムフォレスト(Random Forest)**
```python
from sklearn.ensemble import RandomForestRegressor
# ハイパーパラメータ探索範囲
param_grid = {
    'n_estimators': [50, 100, 200],
    'max_depth': [3, 5, 7, None],
    'min_samples_split': [2, 5, 10],
    'min_samples_leaf': [1, 2, 4]
}
```

**5. 勾配ブースティング(XGBoost)**
```python
from xgboost import XGBRegressor
# ハイパーパラメータ探索範囲
param_grid = {
    'n_estimators': [50, 100, 200],
    'max_depth': [3, 5, 7],
    'learning_rate': [0.01, 0.05, 0.1],
    'subsample': [0.8, 1.0],
    'colsample_bytree': [0.8, 1.0]
}
```

**6. サポートベクター回帰(SVR)**
```python
from sklearn.svm import SVR
# ハイパーパラメータ探索範囲
param_grid = {
    'C': [0.1, 1, 10, 100],
    'gamma': ['scale', 'auto', 0.001, 0.01, 0.1],
    'kernel': ['rbf']
}
```

**7. ニューラルネットワーク(MLP)**
```python
from sklearn.neural_network import MLPRegressor
# ハイパーパラメータ探索範囲
param_grid = {
    'hidden_layer_sizes': [(50,), (100,), (50, 50), (100, 50)],
    'activation': ['relu', 'tanh'],
    'alpha': [0.0001, 0.001, 0.01],
    'learning_rate': ['constant', 'adaptive']
}
```

**4.4 ハイパーパラメータ最適化**
- グリッドサーチ(GridSearchCV)
- 内部5分割交差検証
- 評価指標: 負の平均二乗誤差(neg_mean_squared_error)
- 最適なハイパーパラメータを選択

#### ステップ5: モデル評価

**5.1 回帰性能評価指標**

各モデルについて、5分割交差検証の各foldで以下を算出:

**1. 決定係数(R²)**
```
R² = 1 - (SS_res / SS_tot)
SS_res = Σ(y_i - ŷ_i)²
SS_tot = Σ(y_i - ȳ)²
```

**2. 平均絶対誤差(MAE)**
```
MAE = (1/n) Σ|y_i - ŷ_i|
```

**3. 二乗平均平方根誤差(RMSE)**
```
RMSE = √[(1/n) Σ(y_i - ŷ_i)²]
```

**4. 平均絶対パーセント誤差(MAPE)**
```
MAPE = (100/n) Σ|(y_i - ŷ_i) / y_i|
```

**報告方法:**
- 5foldの平均値±標準偏差
- 95%信頼区間

**5.2 特徴量重要度**
- ランダムフォレスト: Feature Importance
- XGBoost: Feature Importance(gain)
- 線形モデル: 標準化係数の絶対値

上位5つの重要な特徴量を報告

**5.3 予測値 vs 実測値のプロット**
- 散布図
- 対角線(y = x)を追加
- R²とRMSEを図中に表示

**5.4 残差プロット**
- 残差(y - ŷ) vs 予測値(ŷ)
- 水平線(残差 = 0)を追加
- 残差の分布(ヒストグラム)

#### ステップ6: 分類性能評価(副次評価項目)

骨粗鬆症(T-score ≤ -2.5)を陽性とする二値分類:

**6.1 予測確率の算出**
- 回帰モデルの予測BMDからT-scoreを算出
- T-score ≤ -2.5の確率を予測

**6.2 分類性能指標**

**1. ROC曲線とAUC**
```python
from sklearn.metrics import roc_curve, roc_auc_score
fpr, tpr, thresholds = roc_curve(y_true, y_pred_proba)
auc = roc_auc_score(y_true, y_pred_proba)
```

**2. 最適カットオフ値の決定**
- Youden指数を最大化: J = 感度 + 特異度 - 1

**3. 混同行列**
```
              予測陽性   予測陰性
実際陽性        TP        FN
実際陰性        FP        TN
```

**4. 性能指標**
- 感度(Sensitivity): TP / (TP + FN)
- 特異度(Specificity): TN / (TN + FP)
- 陽性的中率(PPV): TP / (TP + FP)
- 陰性的中率(NPV): TN / (TN + FN)
- F1スコア: 2 × (精度 × 再現率) / (精度 + 再現率)
- 正確度(Accuracy): (TP + TN) / (TP + TN + FP + FN)

**報告方法:**
- 各指標の95%信頼区間(ブートストラップ法、1000回)

---

## 5. 統計的仮説検定

### 5.1 主要仮説

**仮説1: 胸椎後弯角度と骨密度の相関**
- 帰無仮説(H0): ρ = 0(相関がない)
- 対立仮説(H1): ρ < 0(負の相関がある)
- 検定方法: Pearsonの相関係数の検定(片側検定)
- 有意水準: α = 0.05

**仮説2: モデル性能の改善**
- 帰無仮説(H0): R²(拡張モデル) - R²(ベースライン) ≤ 0
- 対立仮説(H1): R²(拡張モデル) - R²(ベースライン) > 0.1
- 検定方法: 交差検証によるR²の差のt検定
- 有意水準: α = 0.05

**仮説3: 分類性能**
- 帰無仮説(H0): AUC ≤ 0.75
- 対立仮説(H1): AUC > 0.75
- 検定方法: AUCの95%信頼区間がしきい値を超えるかを評価
- 有意水準: α = 0.05

### 5.2 副次的仮説検定

**群間比較(性別)**
- 男性 vs 女性で骨密度と姿勢パラメータを比較
- 正規分布の場合: 独立t検定(両側)
- 非正規分布の場合: Mann-Whitney U検定
- 有意水準: α = 0.05

**群間比較(年齢層)**
- 3群(40-54歳、55-69歳、70-80歳)で比較
- 正規分布の場合: 一元配置分散分析(ANOVA)
- 非正規分布の場合: Kruskal-Wallis検定
- 有意な場合、多重比較(Tukey HSD法またはDunn検定)
- 有意水準: α = 0.05

**多変量回帰分析**
腰椎BMDを従属変数とする重回帰分析:
```python
import statsmodels.api as sm
X = df[['age', 'sex', 'kyphosis_angle', 'forward_head', 'bmi']]
y = df['lumbar_bmd']
X = sm.add_constant(X)
model = sm.OLS(y, X).fit()
print(model.summary())
```

報告項目:
- 各変数の偏回帰係数(B)
- 標準化偏回帰係数(β)
- 標準誤差(SE)
- t値
- p値
- 95%信頼区間
- モデル全体のR²、調整済みR²、F値、p値
- VIF(多重共線性の確認)

---

## 6. 感度分析

### 6.1 外れ値除外
- 外れ値を除外した場合の解析結果を報告
- 主要評価項目(R²)への影響を評価

### 6.2 Per Protocol解析
- PPSでの解析結果を報告
- FASとの結果の一致性を確認

### 6.3 サブグループ解析

サンプルサイズが十分な場合(各群n ≥ 20)、以下のサブグループで解析:
- 性別(男性 vs 女性)
- 年齢層(中年 vs 高齢)
- BMI(正常 vs 過体重/肥満)

各サブグループでモデルを構築し、R²を比較

### 6.4 異なる交差検証法
- Leave-One-Out交差検証(LOOCV)
- 結果の頑健性を確認

---

## 7. 欠測データへの対応

### 7.1 基本方針
- 主解析: 完全症例解析(Complete Case Analysis)
- 感度分析: 多重代入法(Multiple Imputation)

### 7.2 多重代入法(MICE)
```python
from sklearn.impute import IterativeImputer
imputer = IterativeImputer(random_state=0)
X_imputed = imputer.fit_transform(X)
```
- 5つの代入データセットを生成
- 各データセットで解析を実施
- Rubin's rulesに従って結果を統合

---

## 8. 多重性の調整

### 8.1 主要評価項目
- 1つのみ(腰椎BMDのR²)
- 多重性の調整不要

### 8.2 副次評価項目
- 複数の評価項目があるため、解釈は探索的
- 統計的有意性の解釈には慎重を期す
- 必要に応じてBonferroni補正を適用

### 8.3 サブグループ解析
- 探索的解析として位置づけ
- 多重性の調整は行わないが、結果の解釈には注意

---

## 9. ソフトウェアとバージョン

### 9.1 プログラミング言語
- Python 3.8以上

### 9.2 主要ライブラリ
```python
numpy==1.21.0
pandas==1.3.0
scikit-learn==1.0.0
xgboost==1.5.0
scipy==1.7.0
statsmodels==0.13.0
matplotlib==3.4.0
seaborn==0.11.0
opencv-python==4.5.0
mediapipe==0.8.0  # or OpenPose
```

### 9.3 統計解析環境
- Jupyter Notebook または VS Code
- 乱数シード固定(再現性確保)

---

## 10. 報告基準

本研究の報告は、以下のガイドラインに従う:
- TRIPOD (Transparent Reporting of a multivariable prediction model for Individual Prognosis Or Diagnosis)
- STROBE (Strengthening the Reporting of Observational Studies in Epidemiology)

---

## 11. データ品質管理

### 11.1 データ入力
- ダブルエントリー(2名の研究員が独立して入力)
- 不一致がある場合、原データを確認

### 11.2 データクリーニング
- 範囲外の値のチェック
  - 年齢: 40-80歳
  - BMD: 0.3-1.5 g/cm²
  - 後弯角度: 10-90度
- 論理的矛盾のチェック
  - 身長と体重の整合性

### 11.3 データロック
- すべてのデータクリーニングと品質確認が完了後、データベースをロック
- データロック後は解析のみ実施

---

## 12. タイムライン

| フェーズ | 予定期間 |
|---------|---------|
| データ収集 | 3-6ヶ月 |
| データクリーニング | 2週間 |
| データロック | 1日 |
| 記述統計 | 1週間 |
| モデル構築・評価 | 2-3週間 |
| 統計的検定 | 1週間 |
| 感度分析 | 1週間 |
| 結果の解釈・考察 | 2週間 |
| 論文執筆 | 4週間 |

---

## 13. 解析責任者

| 役割 | 氏名 |
|------|------|
| 主解析担当者 | [氏名] |
| 統計解析監修 | [氏名] |

---

## 14. 改訂履歴

| バージョン | 日付 | 改訂内容 |
|-----------|------|---------|
| 1.0 | 2026年2月3日 | 初版作成 |

---

**本統計解析計画書は、データ収集前に確定し、研究責任者の承認を得たものである。**
